<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Autenticar com a Nvoip</title>
    <style>
      body {
        margin: 0;
        font-family: 'Inter', system-ui, sans-serif;
        background: #0f172a;
        color: #e2e8f0;
        min-height: 100vh;
        display: flex;
        align-items: flex-start;
        justify-content: center;
      }
      .page {
        width: min(640px, 100%);
        padding: 2rem;
      }
      button {
        border: none;
        border-radius: 8px;
        padding: 0.75rem 1.5rem;
        background: #2563eb;
        color: white;
        font-size: 1rem;
        cursor: pointer;
      }
      pre {
        background: rgba(15, 23, 42, 0.85);
        padding: 1rem;
        border-radius: 12px;
        overflow: auto;
      }
      .token-field {
        width: 100%;
        min-height: 120px;
        font-family: 'Inter', system-ui, monospace;
        background: rgba(148, 163, 184, 0.15);
        color: #e2e8f0;
        border: 1px solid rgba(148, 163, 184, 0.6);
        padding: 0.75rem;
        border-radius: 8px;
      }
      .meta {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
      }
      .meta span {
        background: rgba(99, 102, 241, 0.15);
        border-radius: 999px;
        padding: 0.35rem 0.75rem;
        font-size: 0.85rem;
      }
    </style>
  </head>
  <body>
    <div class="page">
      <p class="meta">
        <span id="portal-tag">Portal:</span>
        <span id="account-tag">Account:</span>
      </p>
      <h1>Autenticar com a Nvoip</h1>
      <p>
        Este iframe serve como gatilho de OAuth para permitir que o HubSpot abra a tela
        diretamente nas configurações. Clique no botão abaixo para iniciar o fluxo.
      </p>
      <button id="auth-button">Autenticar com a Nvoip</button>
      <section style="margin-top: 1.25rem;">
        <h2>State enviado</h2>
        <pre id="state-value">carregando…</pre>
      </section>
      <section style="margin-top: 1.25rem;">
        <h2>Tokens</h2>
        <p>
          O handler Netlify (`/nvoip-oauth-callback`) troca o código por tokens e você consegue
          conferir o resultado nos logs (e eventualmente adicionar persistência). Cole o token
          abaixo se quiser inspecionar rapidamente.
        </p>
        <div id="token-area" class="token-field" contenteditable="true" spellcheck="false">
          cole o token aqui após receber pelos logs
        </div>
      </section>
    </div>
    <script>
      const params = new URLSearchParams(window.location.search)
      const portalId = params.get('portalId') || 'sem-portal'
      const accountId = params.get('accountId') || 'sem-account'

      document.getElementById('portal-tag').textContent = `Portal: ${portalId}`
      document.getElementById('account-tag').textContent = `Account: ${accountId}`
      document.getElementById('state-value').textContent = params.get('state') || 'sem-state'

      let config = null
      fetch('/.netlify/functions/oauth-config')
        .then((res) => res.json())
        .then((data) => {
          config = data
        })

      const authButton = document.getElementById('auth-button')
      authButton.addEventListener('click', () => {
        if (!config) return
        const returnUrl = params.get('returnUrl') || config.redirectUri
        const state = params.get('state') || ''
        const url = new URL(`${config.authHost}/auth/oauth2/authorize`)
        url.searchParams.set('response_type', 'code')
        url.searchParams.set('client_id', config.clientId)
        url.searchParams.set('redirect_uri', config.redirectUri)
        url.searchParams.set('state', state)
        url.searchParams.set('scope', config.scope)
        window.open(url.toString(), 'nvoipAuth', 'width=600,height=700')
      })
    </script>
  </body>
</html>
